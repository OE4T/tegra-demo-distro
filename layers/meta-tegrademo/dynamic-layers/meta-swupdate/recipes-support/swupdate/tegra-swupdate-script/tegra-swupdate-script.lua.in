local function get_current_alt_slot()
    local handle = io.popen("nvbootctrl get-current-slot")
    if not handle then
        print("Failed to get-current-slot")
        return nil, nil
    end
    local result = handle:read("*a")
    handle:close()
    local current_slot = result:match("%d") -- Extracts the first digit found
    local alt_slot = current_slot == "1" and "0" or "1"
    return current_slot, alt_slot
end

local function set_active_slot(slot)
    local command = "nvbootctrl set-active-boot-slot " .. slot
    return os.execute(command)
end

local function file_exists(path)
    local file = io.open(path, "r")
    if file then
        file:close()
        return true
    else
        return false
    end
end

local function write_file(path, content)
    local file, err = io.open(path, "w")
    if not file then
        print("Failed to open file for writing: " .. path .. " (" .. tostring(err) .. ")")
        return false
    end
    file:write(content)
    file:close()
    return true
end

function reset_unbootable_status(slot)
    local result = -1
    local slot_str = "SlotA"
    if tostring(slot) == "1" then
        slot_str = "SlotB"
    end

    local value = "\\x00\\x00\\x00\\x00"
    local guid = "781e084c-a330-417c-b678-38e696380cb9"
    local varname = "RootfsStatus" .. slot_str

    -- call external set_efi_var binary
    local cmd = string.format('/bin/sh -c ". /usr/bin/uefi_common.func; set_efi_var \'%s\' \'%s\' \'%s\'"', varname, guid, value)
    result, detail = os.execute(cmd)
    if result ~= true then
        print("WARNING: Unable to reset unbootable status for slot " .. slot_str .. " with command " .. cmd .. " : " .. tostring(detail))
    end
end

function postinst()
    local success = false
    local result = ""
    local current_slot, alt_slot = get_current_alt_slot()
    if not current_slot or not alt_slot then
        result = "Couldn't determine current or alt slot"
        return success, result
    end
    local inprogress_slot_marker = "@TEGRA_SWUPDATE_LAST_CAPSULE_UPDATE_COMPLETE_SLOT_MARKER@" .. alt_slot .. "-inprogress"

    if file_exists("@TEGRA_SWUPDATE_CAPSULE_INSTALL_PATH@") then
        print("Running bootloader update script")
        success, detail = os.execute("/usr/bin/oe4t-set-uefi-OSIndications")
        result = "oe4t-set-uefi-OSIndications complete with "
        if success then
            result = result .. "success"
            print("Resetting unbootable status for slot " .. alt_slot)
            reset_unbootable_status(alt_slot)
            if "@TEGRA_SWUPDATE_LAST_CAPSULE_UPDATE_COMPLETE_SLOT_MARKER@" ~= "" then
                os.remove("@TEGRA_SWUPDATE_LAST_CAPSULE_UPDATE_COMPLETE_SLOT_MARKER@" .. alt_slot)
                local ok = write_file(inprogress_slot_marker, current_slot)
                if ok then
                    print("Wrote capsule update inprogress slot marker for slot " .. alt_slot .. " at " ..  inprogress_slot_marker)
                else
                    print("Failed to write capsule update inprogress slot marker for slot " .. alt_slot .. " at " .. inprogress_slot_marker .. ", slot swiching will be disabled")
                end
            end
        else
            result = result .. "failure: " .. tostring(detail)
        end
    else
        if @TEGRA_SWUPDATE_BOOTLOADER_INSTALL_ONLY_IF_DIFFERENT@ then
            print("Running os switch instead of bootloader update since @TEGRA_SWUPDATE_CAPSULE_INSTALL_PATH@ is missing")
            success, detail = set_active_slot(alt_slot)
            if success then
                result = "switch_slots to " .. alt_slot .. " completed with success"
            else
                result = "switch_slots to " .. alt_slot .. " completed with failure: " .. tostring(detail)
            end
        else
            result = "Missing @TEGRA_SWUPDATE_CAPSULE_INSTALL_PATH@, cannot complete update"
        end

        if "@TEGRA_SWUPDATE_LAST_CAPSULE_UPDATE_COMPLETE_SLOT_MARKER@" ~= "" and file_exists(inprogress_slot_marker) then
            print("WARNING: Last capsule update for slot" .. alt_slot .. " was incomplete as " .. inprogress_slot_marker .. " exists, this target slot may be corrupt.")
        end
    end
    return success, result
end
