From d1428fef6bd84bc1c95351cb179178c60011869b Mon Sep 17 00:00:00 2001
From: Ilies CHERGUI <ilies.chergui@gmail.com>
Date: Sun, 17 Jan 2021 19:34:18 +0000
Subject: [PATCH] tegra210: mender FIT image bootcmd support.

Signed-off-by: Ilies CHERGUI <ilies.chergui@gmail.com>
---
 include/configs/tegra210-common.h |  7 +++++--
 include/env_default.h             |  7 +++++--
 include/env_mender.h              | 18 ++++++++++++++++++
 scripts/config_whitelist.txt      |  1 +
 4 files changed, 29 insertions(+), 4 deletions(-)

diff --git a/include/configs/tegra210-common.h b/include/configs/tegra210-common.h
index 35cead04de..ab38a7e44f 100644
--- a/include/configs/tegra210-common.h
+++ b/include/configs/tegra210-common.h
@@ -41,6 +41,8 @@
  *   for the FDT/DTB to be up to 1M, which is hopefully plenty.
  */
 #define CONFIG_LOADADDR 0x80080000
+/* FIT Image Load address */
+#define CONFIG_FITFDT_LOADADDR 0x90000000
 #define MEM_LAYOUT_ENV_SETTINGS \
 	"scriptaddr=0x90000000\0" \
 	"pxefile_addr_r=0x90100000\0" \
@@ -81,8 +83,9 @@
 		"/chosen/uuid:" \
 		"/chosen/linux,initrd-start:" \
 		"/chosen/linux,initrd-end:" \
-		"/psci/nvidia,system-lp0-disable:" \
-		"/serial-number\0"
+		"/serial-number\0" \
+	"fitfdt_loadaddr=" __stringify(CONFIG_FITFDT_LOADADDR) "\0"
+
 
 /* For USB EHCI controller */
 #define CONFIG_EHCI_IS_TDI
diff --git a/include/env_default.h b/include/env_default.h
index 1a8fa81151..849e32b091 100644
--- a/include/env_default.h
+++ b/include/env_default.h
@@ -35,8 +35,8 @@ const uchar default_environment[] = {
 #ifdef	CONFIG_USE_BOOTARGS
 	"bootargs="	CONFIG_BOOTARGS			"\0"
 #endif
-#ifdef	CONFIG_MENDER_BOOTCOMMAND
-	"bootcmd="	CONFIG_MENDER_BOOTCOMMAND	"\0"
+#ifdef	CONFIG_MENDER_FITFDT_BOOTCOMMAND
+	"bootcmd="	CONFIG_MENDER_FITFDT_BOOTCOMMAND			"\0"
 #endif
 #ifdef	CONFIG_RAMBOOTCOMMAND
 	"ramboot="	CONFIG_RAMBOOTCOMMAND		"\0"
@@ -86,6 +86,9 @@ const uchar default_environment[] = {
 #ifdef	CONFIG_LOADADDR
 	"loadaddr="	__stringify(CONFIG_LOADADDR)	"\0"
 #endif
+#ifdef CONFIG_FITFDT_LOADADDR
+	"fitfdt_loadaddr="	__stringify(CONFIG_FITFDT_LOADADDR)	"\0"
+#endif
 #if defined(CONFIG_PCI_BOOTDELAY) && (CONFIG_PCI_BOOTDELAY > 0)
 	"pcidelay="	__stringify(CONFIG_PCI_BOOTDELAY)"\0"
 #endif
diff --git a/include/env_mender.h b/include/env_mender.h
index fbed122807..4ac9657343 100644
--- a/include/env_mender.h
+++ b/include/env_mender.h
@@ -154,6 +154,24 @@
     "sysboot ${devtype} ${devnum}:${distro_bootpart_hex} any ${scriptaddr} ${prefix}extlinux/extlinux.conf; " \
     "run mender_try_to_recover"
 
+#define CONFIG_MENDER_FITFDT_BOOTCOMMAND                                \
+    "run mender_setup; "                                                \
+    "setenv distro_bootpart ${mender_boot_part}; "                      \
+    "setenv distro_bootpart_hex ${mender_boot_part_hex}; "              \
+    "setenv devnum " __stringify(MENDER_UBOOT_STORAGE_DEVICE) "; "      \
+    "setenv devtype " __stringify(MENDER_UBOOT_STORAGE_INTERFACE) "; "  \
+    "setenv prefix /boot/; "                                            \
+    "setenv load_fit_image load ${devtype} ${devnum}:${distro_bootpart_hex} ${fitfdt_loadaddr} ${prefix}fitImage; "  \
+    MENDER_BOOTARGS                                                     \
+    "setenv bootargs ${bootargs} rw rootwait; "                         \
+    "if test \"${systemd_machine_id}\" != \"\"; then "                  \
+    "setenv bootargs ${bootargs} systemd.machine_id=${systemd_machine_id}; " \
+    "fi; "                                                              \
+    "setenv bootargs ${cbootargs} ${bootargs}; "                        \
+    "run load_fit_image; "                                              \
+    "bootm ${fitfdt_loadaddr}#conf@_ddot___ddot___ddot___ddot__nvidia_platform_t210_porg_kernel-dts_tegra210-p3448-0000-p3449-0000-a02.dtb; " \
+    "run mender_try_to_recover;"
+
 #endif /* !MENDER_AUTO_PROBING */
 
 #endif /* HEADER_ENV_MENDER_H */
diff --git a/scripts/config_whitelist.txt b/scripts/config_whitelist.txt
index 093e432efc..5bf5657a4d 100644
--- a/scripts/config_whitelist.txt
+++ b/scripts/config_whitelist.txt
@@ -508,6 +508,7 @@ CONFIG_FEROCEON_88FR131
 CONFIG_FILE
 CONFIG_FIRMWARE_OFFSET
 CONFIG_FIRMWARE_SIZE
+CONFIG_FITFDT_LOADADDR
 CONFIG_FIXED_PHY
 CONFIG_FIXED_PHY_ADDR
 CONFIG_FIXED_SDHCI_ALIGNED_BUFFER
-- 
2.17.1

